#!/bin/bash -e

# The assemble script builds the application artifacts from a source and
# places them into appropriate directories inside the image.

# Execute the default S2I script
. /usr/libexec/s2i/assemble

set -e

install_tool poetry
echo "---> Upgrade pip to the latest version ..."
$VENV_DIR/bin/pip install --upgrade pip

# Conflict between the builder image and poetry on the use of $VIRTUAL_ENV/src
unset VIRTUAL_ENV

# Replace with our own venv
VIRTUAL_ENV=$HOME/.local/venvs/datanommer
echo "---> Create a virtual environment for datanommer ..."
virtualenv_bin "$VIRTUAL_ENV"
export VIRTUAL_ENV

echo "---> Installing datanommer components ..."
for subpackage in datanommer.models datanommer.commands datanommer.consumer; do
    pushd $subpackage
    echo "Installing python package in $(pwd)"
    poetry install --no-dev -v
    popd
done

# set permissions for any installed artifacts
fix-permissions /opt/app-root -P
